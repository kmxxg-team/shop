<extend name="public/base">

<block name="body">

<fieldset class="layui-elem-field layui-field-title">
<legend>
  <!-- 返回列表按钮 -->
  <button class="layui-btn layui-btn-radius layui-btn-primary" onclick="javascript:window.location='{:url(\'index\')}'"><i class="layui-icon">&#xe65c;</i></button>
  <present name="info">
    编辑权限
  <else />
    新增权限
  </present>
</legend>
</fieldset>

<!-- 判断是新增还是修改 提交到不同的方法 -->
<present name="info">
  <form class="layui-form" action="{:url('edit')}" method="post">
<else />
  <form class="layui-form" action="{:url('add')}" method="post">
</present>

<!-- ID -->
<input type="hidden" name="id" value="{$info.id|default=''}">
  <div class="layui-form-item">
    <label class="layui-form-label">权限名称</label>
    <div class="layui-input-block">
      <input type="name" name="name" required lay-verify="required" placeholder="请输入权限资源" autocomplete="off" class="layui-input" value="{$info.name|default=''}">
    </div>
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">所属分组</label>
    <div class="layui-input-block">
      <select name="group" id="right_group" lay-verify="" lay-search>
        <option value="">请选择分组</option>
        <volist name="right_group" id="item" empty="暂时没有数据">
          <option value="{$key}"
            <present name="info"><if condition="$info.group eq $key">selected</if></present>
          >{$item}</option>
        </volist>
      </select>
    </div>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label">添加权限码</label>
    <div class="layui-input-inline">
      <select id="controller" lay-filter="controller_list" lay-verify="" lay-search>
        <option value="">请选择控制器</option>
        <volist name="plan_list" id="item">
          <option value="{$item}">{$item}</option>
        </volist>
      </select>
    </div>
    <div class="layui-input-inline" lay-filter="act_list">
      <select id="act_list"  lay-verify="" lay-search>
        <option value="">请选择方法</option>
      </select>
    </div>
    <button type="button" class="layui-btn" onclick="add_right()">添加</button>
  </div>

  <div class="layui-form-item">
    <label class="layui-form-label">权限码</label>
    <div class="layui-input-block">
      <table class="layui-table" lay-skin="line" lay-size="sm">
        <thead>
          <tr>
            <th>权限码</th>
            <th>操作</th>
          </tr> 
        </thead>
        <tbody id="right_list">
          <present name="info">
          <volist name="info.right" id='item'>
            <tr>
              <td>
                <input type="text" name="right[]" required lay-verify="required" placeholder="请输入权限码" autocomplete="off" class="layui-input form-control" value="{$item}">
              </td>
              <td>
                <button class="layui-btn layui-btn-xs" onclick="$(this).parent().parent().remove();">删除</button>
              </td>
            </tr>
          </volist>
          </present>
        </tbody>
      </table>

    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-input-block">
      <button class="layui-btn" lay-submit lay-filter="submitForm">立即提交</button>
      <notpresent name="info">
      <button type="reset" class="layui-btn layui-btn-primary">重置</button>
      </notpresent>
    </div>
  </div>
</form>
 
<script>

  layui.use('form', function(){
    var form = layui.form;
    $ = layui.jquery;

    form.on('select(controller_list)', function(data){
      $.ajax({
        url: "{:url('admin/SystemMenu/ajax_get_action')}",
        type: 'post',
        data: {'controller':data.value},
        dataType: 'html',
        success:function(res){
          $('#act_list').empty().append(res);
          form.render('select');
        }
      });
    });   
    
  });

  function add_right(){
    var a = [];
    $('#right_list .form-control').each(function(i,o){
      if($(o).val() != ''){
        a.push($(o).val());
      }
    })
    var ncode = $('#controller').val();
    if(ncode !== ''){
      var temp = ncode+'@'+ $('#act_list').val();
      if($.inArray(temp,a) != -1){
        layer.msg('此权限码已经添加！', {icon: 2,time: 1000});
        return false;
      }
    }
    var strtr = '<tr>';
    if(ncode!= ''){
      strtr += '<td><input type="text" name="right[]" required lay-verify="required" placeholder="请输入权限码" autocomplete="off" class="layui-input form-control" value="'+ncode+'@'+ $('#act_list').val()+'"></td>';
    }else{
      strtr += '<td><input type="text" name="right[]" required lay-verify="required" placeholder="请输入权限码" autocomplete="off" class="layui-input form-control" value=""></td>';
    }   
    strtr += '<td><button class="layui-btn layui-btn-xs" onclick="$(this).parent().parent().remove();">删除</button></td>';
    $('#right_list').append(strtr);
  }


</script>

</block>

