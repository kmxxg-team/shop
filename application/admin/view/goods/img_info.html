<extend name="public/base">

<block name="style">
<style type="text/css">
.layui-elem-field{
	padding:10px;
}
.img-box{
	float:left;
	height:auto;
	border:1px solid #ddd;
	border-radius: 4px;
	padding:10px;
	overflow:hidden;
}
.img-box img{
	max-width:100%;
	height:auto;
	cursor:pointer;
}
.btn-box{
	text-align:center;
	width: 100%;
	margin-top: 10px;
}
.btn-box .layui-btn{
	width: 100%;
}
</style>
</block>

<block name="body">

<fieldset class="layui-elem-field layui-field-title">
<legend>
  <!-- 返回列表按钮 -->
  <button class="layui-btn layui-btn-radius layui-btn-primary" onclick="javascript:window.location='{:url(\'index\')}'"><i class="layui-icon">&#xe65c;</i></button>
  <empty name="$Request.get.goods_id">
    添加商品
  <else />
    商品设置 - 商品相册
  </empty>
</legend>
</fieldset>

<div class="layui-tab">
  <ul class="layui-tab-title">
    <li class="jump-tab" page-url="{:url('info', ['goods_id'=>$Request.get.goods_id])}">通用信息</li>
    <li class="layui-this">商品相册</li>
    <li>商品模型</li>
    <li>商品物流</li>
    <li>积分折扣</li>
  </ul>

  <div class="layui-tab-content">
    <div class="layui-tab-item layui-show" >
    	<fieldset class="layui-elem-field">
		  	<legend>图片</legend>
		  	<empty name="images">
		  		<span class="layui-badge-dot layui-bg-green"></span>&nbsp;暂无图片
		  	<else/>
			  	<volist name="images" id="image">
				  	<div class="img-box layui-col-md2">
			 			<img src="{$image.image_url}" />
			 			<div class="btn-box"><button class="layui-btn layui-btn-xs layui-btn-normal img-del-btn" data-url="{:url('deleteImg', ['id'=>$image.img_id])}">删除</button></div>
				  	</div>
			  	</volist>					
		  	</empty>
		</fieldset>
		<br>
		<div class="layui-upload">
		  <button type="button" class="layui-btn layui-btn-normal" id="img-select">选择多文件</button> 
		  <div class="layui-upload-list">
		    <table class="layui-table">
		      <thead>
		        <tr><th>文件名</th>
		        <th>大小</th>
		        <th>状态</th>
		        <th>操作</th>
		      </tr></thead>
		      <tbody id="img-list"></tbody>
		    </table>
		  </div>
		  <button type="button" class="layui-btn" id="upload-action">开始上传</button>
		  <button type="button" class="layui-btn" onclick="javascript:location.reload();">刷新</button>
		</div> 
    </div>
  </div>
</div>

<!-- <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
<script type="text/javascript" src="__ROOT__/plugins/wangEditor/release/wangEditor.min.js"></script>
<script>
layui.use('element', function(){
	var element = layui.element;
	var $ = layui.jquery;

	//wangEditor文本编辑器
	var E = window.wangEditor;
	var editor = new E('#editor');
	var $text = $('#goods_content');
	editor.customConfig.onchange = function (html) {
	    // 监控变化，同步更新到 textarea
	    $text.val(html);
	}
	// 或者 var editor = new E( document.getElementById('editor') )
	editor.create();
	// 初始化 textarea 的值
	$text.val(editor.txt.html());
});

/**
 * 设置tab标签跳转
 */
$('.layui-tab-title .jump-tab').on('click', function(){
	var url = $(this).attr('page-url');
	window.location.href = url;
});

/**
* 多文件列表上传
*/
layui.use('upload', function(){
	var upload = layui.upload;

	var demoListView = $('#img-list')
	,uploadListIns = upload.render({
	elem: '#img-select'
	,url: "{:url('updateImg', ['goods_id' => $Request.get.goods_id])}"
	,accept: 'images'
	,multiple: true
	,auto: false
	,bindAction: '#upload-action'
	,choose: function(obj){   
	  var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
	  //读取本地文件
	  obj.preview(function(index, file, result){
	    var tr = $(['<tr id="upload-'+ index +'">'
	      ,'<td>'+ file.name +'</td>'
	      ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
	      ,'<td>等待上传</td>'
	      ,'<td>'
	        ,'<button class="layui-btn layui-btn-mini demo-reload layui-hide">重传</button>'
	        ,'<button class="layui-btn layui-btn-mini layui-btn-danger demo-delete">删除</button>'
	      ,'</td>'
	    ,'</tr>'].join(''));
	    
	    //单个重传
	    tr.find('.demo-reload').on('click', function(){
	      obj.upload(index, file);
	    });
	    
	    //删除
	    tr.find('.demo-delete').on('click', function(){
	      delete files[index]; //删除对应的文件
	      tr.remove();
	      uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
	    });
	    
	    demoListView.append(tr);
	  });
	}
	,done: function(res, index, upload){
	  if(res.code == 0){ //上传成功
	    var tr = demoListView.find('tr#upload-'+ index)
	    ,tds = tr.children();
	    tds.eq(2).html('<span style="color: #5FB878;">上传成功 请刷新页面查看</span>');
	    tds.eq(3).html(''); //清空操作
	    return delete this.files[index]; //删除文件队列已经上传成功的文件
	  }
	  this.error(index, upload);
	}
	,error: function(index, upload){
	  var tr = demoListView.find('tr#upload-'+ index)
	  ,tds = tr.children();
	  tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
	  tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
	}
	});
});


/**
 * 单个图片删除按钮
 */
layui.use('layer', function(){
  var layer = layui.layer;
	$('.img-del-btn').on('click', function(){
  		var tips = '您确定要删除图片？';
        var server_url = $(this).attr('data-url');
  		layer.confirm(tips, {btn:['确定', '取消']},
            function(){
                $.get(server_url, {}, function(result){
                    if (!result.code) {
                        layer.msg(result.msg || '操作失败', {icon:5});
                        return false;
                    }
                    layer.msg(result.msg || '操作成功', {icon:6});
                    // 刷新当前页
                    setTimeout(function(){location.reload();}, 2000);
                });
            },
            function(){
                return;
            },
        );
	});
});              

/**
 * 图片预览
 */
 //调用示例
layui.use('layer', function(){
 	var layer = layui.layer;
	layer.photos({
	  photos: '.img-box'
	  ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
	}); 
});
</script>

</block>